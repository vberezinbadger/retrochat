<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    
    <title>–í–µ–±-—á–∞—Ç</title>
    <link rel="stylesheet" type="text/css" href="style.css" />
    
    <!-- –î–µ—Ç–µ–∫—Ü–∏—è –æ—á–µ–Ω—å —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ -->
    <script type="text/javascript">
        // –ü—Ä–æ—Å—Ç–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ JS
        var ua = navigator.userAgent.toLowerCase();
        var isOldBrowser = ua.indexOf('opera mini') > -1 || 
                          ua.indexOf('symbian') > -1 || 
                          ua.indexOf('series60') > -1 ||
                          typeof document.getElementById == 'undefined';
        
        if (isOldBrowser) {
            document.documentElement.className += ' old-browser';
        }
    </script>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
    <div id="loginScreen" class="screen">
        <div class="container">
            <h1>üí¨ –í–µ–±-—á–∞—Ç</h1>
            <form id="loginForm" method="post" action="javascript:void(0);">
                <table width="100%" border="0" cellpadding="0" cellspacing="0">
                    <tr>
                        <td>
                            <input 
                                type="text" 
                                id="nicknameInput" 
                                name="nickname"
                                value="" 
                                maxlength="20"
                                style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ccc;"
                            />
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <input 
                                type="button" 
                                value="–í–æ–π—Ç–∏ –≤ —á–∞—Ç" 
                                onclick="handleLogin()"
                                style="width: 100%; padding: 10px; background: #3498db; color: white; border: none;"
                            />
                        </td>
                    </tr>
                </table>
            </form>
            <div style="margin-top: 10px; font-size: 10px; color: #666;">
                –î–ª—è —Å—Ç–∞—Ä—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            </div>
        </div>
    </div>

    <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
    <div id="chatScreen" class="screen hidden">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="chat-header">
            <table width="100%" border="0" cellpadding="0" cellspacing="0">
                <tr>
                    <td id="userNickname" style="color: white; font-weight: bold;"></td>
                    <td align="right">
                        <input 
                            type="button" 
                            value="–í—ã—Ö–æ–¥" 
                            onclick="handleLogout()"
                            style="padding: 4px 8px; font-size: 10px; background: #e74c3c; color: white; border: none;"
                        />
                    </td>
                </tr>
            </table>
        </div>
        
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        <div id="messagesContainer" class="messages-container">
            <div id="messagesList" class="messages-list">
                <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
        
        <!-- –í–≤–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è -->
        <div class="chat-input">
            <form method="post" action="javascript:void(0);">
                <table width="100%" border="0" cellpadding="0" cellspacing="0">
                    <tr>
                        <td width="70%">
                            <input 
                                type="text" 
                                id="messageInput" 
                                name="message"
                                value=""
                                maxlength="500"
                                style="width: 100%; padding: 6px; border: 1px solid #ccc;"
                            />
                        </td>
                        <td width="30%" align="right">
                            <input 
                                type="button" 
                                value="üì§" 
                                onclick="handleSendMessage()"
                                style="width: 100%; padding: 6px; background: #3498db; color: white; border: none;"
                            />
                        </td>
                    </tr>
                </table>
            </form>
        </div>
    </div>

    <!-- –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π JavaScript –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ -->
    <script type="text/javascript">
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        var currentUser = null;
        var lastMessageTime = 0;
        var pollInterval = null;
        var isOldBrowser = typeof XMLHttpRequest == 'undefined';
        
        // –°–æ–∑–¥–∞–Ω–∏–µ XHR –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        function createXHR() {
            if (typeof XMLHttpRequest != 'undefined') {
                return new XMLHttpRequest();
            } else if (typeof ActiveXObject != 'undefined') {
                try {
                    return new ActiveXObject('Microsoft.XMLHTTP');
                } catch (e) {
                    try {
                        return new ActiveXObject('Msxml2.XMLHTTP');
                    } catch (e2) {
                        return null;
                    }
                }
            }
            return null;
        }
        
        // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ trim –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        function trim(str) {
            return str.replace(/^\s+|\s+$/g, '');
        }
        
        // –í—Ö–æ–¥ –≤ —á–∞—Ç
        function handleLogin() {
            var nicknameInput = document.getElementById('nicknameInput');
            var nickname = trim(nicknameInput.value);
            
            if (nickname.length < 2) {
                alert('–ù–∏–∫–Ω–µ–π–º –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞');
                return;
            }
            
            currentUser = nickname;
            document.getElementById('userNickname').innerHTML = nickname;
            
            // –°–∫—Ä—ã—Ç—å —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞, –ø–æ–∫–∞–∑–∞—Ç—å —á–∞—Ç
            document.getElementById('loginScreen').className = 'screen hidden';
            document.getElementById('chatScreen').className = 'screen';
            
            // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
            loadMessages();
            
            // –ó–∞–ø—É—Å—Ç–∏—Ç—å polling
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(loadNewMessages, 3000);
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        function loadMessages() {
            var xhr = createXHR();
            if (!xhr) {
                document.getElementById('messagesList').innerHTML = '<div class="error">–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</div>';
                return;
            }
            
            xhr.open('GET', '/api/messages?limit=20', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    if (xhr.status == 200) {
                        try {
                            var messages = eval('(' + xhr.responseText + ')'); // JSON.parse –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                            displayMessages(messages);
                        } catch (e) {
                            document.getElementById('messagesList').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
                        }
                    } else {
                        document.getElementById('messagesList').innerHTML = '<div class="error">–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>';
                    }
                }
            };
            xhr.send();
        }
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        function loadNewMessages() {
            var xhr = createXHR();
            if (!xhr) return;
            
            xhr.open('GET', '/api/messages?since=' + lastMessageTime, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    try {
                        var messages = eval('(' + xhr.responseText + ')');
                        if (messages.length > 0) {
                            appendMessages(messages);
                        }
                    } catch (e) {
                        // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
                    }
                }
            };
            xhr.send();
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
        function displayMessages(messages) {
            var html = '';
            for (var i = 0; i < messages.length; i++) {
                html += formatMessage(messages[i]);
                if (messages[i].timestamp > lastMessageTime) {
                    lastMessageTime = messages[i].timestamp;
                }
            }
            document.getElementById('messagesList').innerHTML = html;
            scrollToBottom();
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        function appendMessages(messages) {
            var messagesList = document.getElementById('messagesList');
            var html = messagesList.innerHTML;
            
            for (var i = 0; i < messages.length; i++) {
                // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–≤–æ–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–≤—Ç–æ—Ä–Ω–æ
                if (!(messages[i].source == 'user' && messages[i].nickname == currentUser)) {
                    html += formatMessage(messages[i]);
                }
                if (messages[i].timestamp > lastMessageTime) {
                    lastMessageTime = messages[i].timestamp;
                }
            }
            
            messagesList.innerHTML = html;
            scrollToBottom();
        }
        
        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function formatMessage(msg) {
            var cssClass = msg.source || 'user';
            var time = new Date(msg.timestamp);
            var hours = time.getHours();
            var minutes = time.getMinutes();
            if (minutes < 10) minutes = '0' + minutes;
            
            return '<div class="message ' + cssClass + '">' +
                   '<div class="message-author">' + msg.nickname + '</div>' +
                   '<div class="message-text">' + msg.text + '</div>' +
                   '<div class="message-time">' + hours + ':' + minutes + '</div>' +
                   '</div>';
        }
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        function handleSendMessage() {
            var messageInput = document.getElementById('messageInput');
            var message = trim(messageInput.value);
            
            if (!message) return;
            
            // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—Ä–∞–∑—É
            var messageData = {
                nickname: currentUser,
                text: message,
                timestamp: new Date().getTime(),
                source: 'user'
            };
            
            appendMessages([messageData]);
            messageInput.value = '';
            
            // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            var xhr = createXHR();
            if (!xhr) return;
            
            xhr.open('POST', '/api/messages', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    if (xhr.status == 200) {
                        lastMessageTime = messageData.timestamp;
                    } else {
                        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
                        var errorMsg = {
                            nickname: '–°–∏—Å—Ç–µ–º–∞',
                            text: '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è',
                            timestamp: new Date().getTime(),
                            source: 'error'
                        };
                        appendMessages([errorMsg]);
                    }
                }
            };
            
            // –ü—Ä–æ—Å—Ç–∞—è JSON —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
            var jsonData = '{"nickname":"' + currentUser + '","text":"' + message.replace(/"/g, '\\"') + '","timestamp":' + messageData.timestamp + '}';
            xhr.send(jsonData);
        }
        
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑
        function scrollToBottom() {
            var container = document.getElementById('messagesContainer');
            if (container.scrollTop !== undefined) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        // –í—ã—Ö–æ–¥ –∏–∑ —á–∞—Ç–∞
        function handleLogout() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            
            currentUser = null;
            lastMessageTime = 0;
            document.getElementById('messagesList').innerHTML = '';
            document.getElementById('nicknameInput').value = '';
            
            document.getElementById('chatScreen').className = 'screen hidden';
            document.getElementById('loginScreen').className = 'screen';
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞
        function handleKeyPress(event, action) {
            var keyCode = event.keyCode || event.which;
            if (keyCode == 13) { // Enter
                if (action == 'login') {
                    handleLogin();
                } else if (action == 'send') {
                    handleSendMessage();
                }
                return false;
            }
            return true;
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ Enter
            var nicknameInput = document.getElementById('nicknameInput');
            var messageInput = document.getElementById('messageInput');
            
            if (nicknameInput.addEventListener) {
                nicknameInput.addEventListener('keypress', function(e) { return handleKeyPress(e, 'login'); }, false);
                messageInput.addEventListener('keypress', function(e) { return handleKeyPress(e, 'send'); }, false);
            } else {
                nicknameInput.onkeypress = function(e) { return handleKeyPress(e || window.event, 'login'); };
                messageInput.onkeypress = function(e) { return handleKeyPress(e || window.event, 'send'); };
            }
        };
    </script>
    
    <!-- Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –±–µ–∑ JavaScript -->
    <noscript>
        <div style="padding: 20px; margin: 20px; background: #fff3cd; border: 1px solid #ffeaa7; text-align: center;">
            <h2>–¢—Ä–µ–±—É–µ—Ç—Å—è JavaScript</h2>
            <p>–í–∫–ª—é—á–∏—Ç–µ JavaScript –¥–ª—è —Ä–∞–±–æ—Ç—ã —á–∞—Ç–∞.</p>
        </div>
    </noscript>
</body>
</html>
