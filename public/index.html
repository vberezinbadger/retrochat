<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=240">
    <title>Чат</title>
    <style>
        body { font-family: Arial; font-size: 12px; margin: 0; padding: 0; background: #f0f0f0; }
        .screen { width: 100%; }
        .hidden { display: none; }
        .container { width: 90%; max-width: 280px; margin: 20px auto; padding: 15px; background: white; border: 1px solid #ccc; }
        h1 { margin: 0 0 15px 0; font-size: 16px; text-align: center; }
        input[type=text] { width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; font-size: 12px; }
        input[type=button] { width: 100%; padding: 8px; background: #007acc; color: white; border: none; font-size: 12px; }
        .chat-header { background: #333; color: white; padding: 8px; font-size: 11px; }
        .logout-btn { float: right; padding: 4px 8px; background: #cc0000; color: white; border: none; font-size: 10px; }
        .messages { height: 250px; overflow-y: auto; border: 1px solid #ccc; background: white; }
        .msg-list { padding: 5px; }
        .msg { margin: 5px 0; padding: 5px; border-left: 3px solid #ccc; background: #f9f9f9; font-size: 11px; }
        .msg.user { background: #e8f5e8; border-left-color: #28a745; margin-left: 20px; }
        .msg.telegram { background: #e3f2fd; border-left-color: #007acc; margin-right: 20px; }
        .msg-author { font-weight: bold; font-size: 10px; margin-bottom: 2px; }
        .msg-text { font-size: 11px; margin-bottom: 2px; }
        .msg-time { font-size: 9px; color: #666; }
        .input-area { background: #eee; padding: 5px; border: 1px solid #ccc; }
        .input-table { width: 100%; }
        .input-table td { vertical-align: top; }
        .send-btn { width: 100%; padding: 6px; background: #007acc; color: white; border: none; font-size: 11px; }
        .loading { text-align: center; padding: 15px; color: #666; }
        .error { background: #ffebee; color: #c62828; padding: 8px; margin: 5px 0; border: 1px solid #ffcdd2; }
    </style>
</head>
<body>
    <!-- Экран входа -->
    <div id="loginScreen" class="screen">
        <div class="container">
            <h1>Веб-чат</h1>
            <input type="text" id="nicknameInput" placeholder="Введите никнейм" maxlength="20">
            <input type="button" value="Войти в чат" onclick="login()">
        </div>
    </div>

    <!-- Экран чата -->
    <div id="chatScreen" class="screen hidden">
        <div class="chat-header">
            <span id="userNick"></span>
            <input type="button" class="logout-btn" value="Выход" onclick="logout()">
            <div style="clear: both;"></div>
        </div>
        
        <div class="messages" id="messagesContainer">
            <div class="msg-list" id="messagesList">
                <div class="loading">Загрузка...</div>
            </div>
        </div>
        
        <div class="input-area">
            <table class="input-table">
                <tr>
                    <td width="70%">
                        <input type="text" id="messageInput" placeholder="Сообщение" maxlength="300">
                    </td>
                    <td width="30%">
                        <input type="button" class="send-btn" value="Отправить" onclick="sendMessage()">
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        var currentUser = null;
        var lastMessageTime = 0;
        var pollTimer = null;
        
        function createXHR() {
            if (window.XMLHttpRequest) return new XMLHttpRequest();
            if (window.ActiveXObject) {
                try { return new ActiveXObject('Microsoft.XMLHTTP'); }
                catch(e) { return null; }
            }
            return null;
        }
        
        function trim(str) {
            return str.replace(/^\s+|\s+$/g, '');
        }
        
        function login() {
            var input = document.getElementById('nicknameInput');
            var nickname = trim(input.value);
            
            if (nickname.length < 2) {
                alert('Никнейм должен содержать минимум 2 символа');
                return;
            }
            
            currentUser = nickname;
            document.getElementById('userNick').innerHTML = nickname;
            
            document.getElementById('loginScreen').className = 'screen hidden';
            document.getElementById('chatScreen').className = 'screen';
            
            loadMessages();
            startPolling();
        }
        
        function loadMessages() {
            var xhr = createXHR();
            if (!xhr) {
                showError('Браузер не поддерживается');
                return;
            }
            
            xhr.open('GET', '/api/messages?limit=20', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    if (xhr.status == 200) {
                        try {
                            var messages = eval('(' + xhr.responseText + ')');
                            displayMessages(messages);
                        } catch (e) {
                            showError('Ошибка загрузки сообщений');
                        }
                    } else {
                        showError('Ошибка соединения');
                    }
                }
            };
            xhr.send();
        }
        
        function startPolling() {
            if (pollTimer) clearInterval(pollTimer);
            pollTimer = setInterval(function() {
                var xhr = createXHR();
                if (!xhr) return;
                
                xhr.open('GET', '/api/messages?since=' + lastMessageTime, true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4 && xhr.status == 200) {
                        try {
                            var messages = eval('(' + xhr.responseText + ')');
                            if (messages.length > 0) {
                                appendMessages(messages);
                            }
                        } catch (e) {}
                    }
                };
                xhr.send();
            }, 2000);
        }
        
        function displayMessages(messages) {
            var html = '';
            for (var i = 0; i < messages.length; i++) {
                html += formatMessage(messages[i]);
                if (messages[i].timestamp > lastMessageTime) {
                    lastMessageTime = messages[i].timestamp;
                }
            }
            document.getElementById('messagesList').innerHTML = html;
            scrollToBottom();
        }
        
        function appendMessages(messages) {
            var list = document.getElementById('messagesList');
            var html = list.innerHTML;
            
            for (var i = 0; i < messages.length; i++) {
                html += formatMessage(messages[i]);
                if (messages[i].timestamp > lastMessageTime) {
                    lastMessageTime = messages[i].timestamp;
                }
            }
            
            list.innerHTML = html;
            scrollToBottom();
        }
        
        function formatMessage(msg) {
            var time = new Date(msg.timestamp);
            var hours = time.getHours();
            var minutes = time.getMinutes();
            if (minutes < 10) minutes = '0' + minutes;
            
            return '<div class="msg ' + (msg.source || 'user') + '">' +
                   '<div class="msg-author">' + msg.nickname + '</div>' +
                   '<div class="msg-text">' + msg.text + '</div>' +
                   '<div class="msg-time">' + hours + ':' + minutes + '</div>' +
                   '</div>';
        }
        
        function sendMessage() {
            var input = document.getElementById('messageInput');
            var text = trim(input.value);
            
            if (!text) return;
            
            // Показать сразу
            var msg = {
                nickname: currentUser,
                text: text,
                timestamp: new Date().getTime(),
                source: 'user'
            };
            appendMessages([msg]);
            input.value = '';
            
            // Отправить на сервер
            var xhr = createXHR();
            if (!xhr) return;
            
            xhr.open('POST', '/api/messages', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            var data = '{"nickname":"' + currentUser + '","text":"' + text.replace(/"/g, '\\"') + '"}';
            xhr.send(data);
        }
        
        function scrollToBottom() {
            var container = document.getElementById('messagesContainer');
            if (container.scrollTop !== undefined) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        function logout() {
            if (pollTimer) clearInterval(pollTimer);
            
            currentUser = null;
            lastMessageTime = 0;
            document.getElementById('messagesList').innerHTML = '';
            document.getElementById('nicknameInput').value = '';
            
            document.getElementById('chatScreen').className = 'screen hidden';
            document.getElementById('loginScreen').className = 'screen';
        }
        
        function showError(text) {
            document.getElementById('messagesList').innerHTML = 
                '<div class="error">' + text + '</div>';
        }
        
        // Обработка Enter
        function handleKey(event, action) {
            var key = event.keyCode || event.which;
            if (key == 13) {
                if (action == 'login') login();
                else if (action == 'send') sendMessage();
                return false;
            }
            return true;
        }
        
        window.onload = function() {
            var nickInput = document.getElementById('nicknameInput');
            var msgInput = document.getElementById('messageInput');
            
            if (nickInput.addEventListener) {
                nickInput.addEventListener('keypress', function(e) { return handleKey(e, 'login'); });
                msgInput.addEventListener('keypress', function(e) { return handleKey(e, 'send'); });
            } else {
                nickInput.onkeypress = function(e) { return handleKey(e || window.event, 'login'); };
                msgInput.onkeypress = function(e) { return handleKey(e || window.event, 'send'); };
            }
        };
    </script>
</body>
</html>
            
            if (!message) return;
            
            // Показать сообщение сразу
            var messageData = {
                nickname: currentUser,
                text: message,
                timestamp: new Date().getTime(),
                source: 'user'
            };
            
            appendMessages([messageData]);
            messageInput.value = '';
            
            // Отправить на сервер
            var xhr = createXHR();
            if (!xhr) return;
            
            xhr.open('POST', '/api/messages', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    if (xhr.status == 200) {
                        lastMessageTime = messageData.timestamp;
                    } else {
                        // Показать ошибку
                        var errorMsg = {
                            nickname: 'Система',
                            text: 'Ошибка отправки сообщения',
                            timestamp: new Date().getTime(),
                            source: 'error'
                        };
                        appendMessages([errorMsg]);
                    }
                }
            };
            
            // Простая JSON сериализация для старых браузеров
            var jsonData = '{"nickname":"' + currentUser + '","text":"' + message.replace(/"/g, '\\"') + '","timestamp":' + messageData.timestamp + '}';
            xhr.send(jsonData);
        }
        
        // Прокрутка вниз
        function scrollToBottom() {
            var container = document.getElementById('messagesContainer');
            if (container.scrollTop !== undefined) {
                container.scrollTop = container.scrollHeight;
            }
        }
        
        // Выход из чата
        function handleLogout() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
            
            currentUser = null;
            lastMessageTime = 0;
            document.getElementById('messagesList').innerHTML = '';
            document.getElementById('nicknameInput').value = '';
            
            document.getElementById('chatScreen').className = 'screen hidden';
            document.getElementById('loginScreen').className = 'screen';
        }
        
        // Обработка Enter в полях ввода
        function handleKeyPress(event, action) {
            var keyCode = event.keyCode || event.which;
            if (keyCode == 13) { // Enter
                if (action == 'login') {
                    handleLogin();
                } else if (action == 'send') {
                    handleSendMessage();
                }
                return false;
            }
            return true;
        }
        
        // Инициализация после загрузки страницы
        window.onload = function() {
            // Добавляем обработчики Enter
            var nicknameInput = document.getElementById('nicknameInput');
            var messageInput = document.getElementById('messageInput');
            
            if (nicknameInput.addEventListener) {
                nicknameInput.addEventListener('keypress', function(e) { return handleKeyPress(e, 'login'); }, false);
                messageInput.addEventListener('keypress', function(e) { return handleKeyPress(e, 'send'); }, false);
            } else {
                nicknameInput.onkeypress = function(e) { return handleKeyPress(e || window.event, 'login'); };
                messageInput.onkeypress = function(e) { return handleKeyPress(e || window.event, 'send'); };
            }
        };
    </script>
    
    <!-- Fallback для браузеров без JavaScript -->
    <noscript>
        <div style="padding: 20px; margin: 20px; background: #fff3cd; border: 1px solid #ffeaa7; text-align: center;">
            <h2>Требуется JavaScript</h2>
            <p>Включите JavaScript для работы чата.</p>
        </div>
    </noscript>
</body>
</html>
