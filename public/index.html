<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Чат</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            font-size: 12px;
            background: #e6e6e6;
            color: #000;
            width: 100%;
            height: 100%;
        }
        
        .screen {
            width: 100%;
            height: 100vh;
            position: relative;
        }
        
        .hidden {
            display: none;
        }
        
        /* === ЭКРАН ВХОДА === */
        .login-screen {
            background: #e6e6e6;
            display: table;
            width: 100%;
            height: 100vh;
        }
        
        .login-wrapper {
            display: table-cell;
            vertical-align: middle;
            text-align: center;
            padding: 20px;
        }
        
        .login-box {
            background: #f8f8f8;
            border: 2px solid #999;
            border-radius: 8px;
            margin: 0 auto;
            max-width: 280px;
            padding: 20px;
            box-shadow: 2px 2px 4px #ccc;
        }
        
        .login-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        
        .login-subtitle {
            font-size: 11px;
            color: #666;
            margin-bottom: 15px;
        }
        
        .input-wrapper {
            margin-bottom: 15px;
            text-align: left;
        }
        
        .input-label {
            display: block;
            font-size: 11px;
            color: #333;
            margin-bottom: 3px;
        }
        
        .text-input {
            width: 100%;
            padding: 8px 6px;
            border: 1px solid #999;
            border-radius: 3px;
            font-size: 12px;
            background: #fff;
            color: #000;
        }
        
        .text-input:focus {
            border-color: #0066cc;
            outline: none;
        }
        
        .login-button {
            width: 100%;
            padding: 10px;
            background: #0066cc;
            color: #fff;
            border: 1px solid #004499;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .login-button:active {
            background: #004499;
        }
        
        /* === ЭКРАН ЧАТА === */
        .chat-screen {
            background: #f0f0f0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Заголовок чата */
        .chat-header {
            background: #4d4d4d;
            color: #fff;
            padding: 8px 10px;
            font-size: 11px;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
            position: relative;
        }
        
        .user-info {
            font-weight: bold;
            display: inline-block;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .logout-button {
            position: absolute;
            right: 8px;
            top: 50%;
            margin-top: -10px;
            padding: 4px 8px;
            background: #cc0000;
            color: #fff;
            border: 1px solid #990000;
            border-radius: 2px;
            font-size: 10px;
            cursor: pointer;
        }
        
        .logout-button:active {
            background: #990000;
        }
        
        /* Область сообщений */
        .messages-area {
            flex: 1;
            overflow-y: auto;
            background: #fff;
            border-left: 1px solid #ccc;
            border-right: 1px solid #ccc;
            padding: 8px;
            min-height: 0;
        }
        
        .message {
            margin-bottom: 10px;
            clear: both;
        }
        
        .message-bubble {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 6px 8px;
            max-width: 85%;
            word-wrap: break-word;
        }
        
        .message.user .message-bubble {
            background: #e6f3ff;
            border-color: #0066cc;
            float: right;
            margin-left: 15%;
        }
        
        .message.telegram .message-bubble {
            background: #fff3e6;
            border-color: #ff9900;
            float: left;
            margin-right: 15%;
        }
        
        .message.error .message-bubble {
            background: #ffe6e6;
            border-color: #cc0000;
            margin: 0 auto;
            text-align: center;
            color: #cc0000;
        }
        
        .message-header {
            font-size: 10px;
            color: #666;
            margin-bottom: 3px;
            font-weight: bold;
        }
        
        .message-text {
            font-size: 11px;
            line-height: 1.3;
            margin-bottom: 3px;
            color: #000;
        }
        
        .message-time {
            font-size: 9px;
            color: #999;
            text-align: right;
        }
        
        /* Область ввода */
        .input-area {
            background: #e6e6e6;
            border-top: 1px solid #ccc;
            padding: 6px;
            flex-shrink: 0;
        }
        
        .input-container {
            display: table;
            width: 100%;
            background: #fff;
            border: 1px solid #999;
            border-radius: 3px;
        }
        
        .message-input {
            display: table-cell;
            width: 70%;
            padding: 6px 8px;
            border: none;
            font-size: 11px;
            background: transparent;
            outline: none;
        }
        
        .send-button {
            display: table-cell;
            width: 30%;
            padding: 6px 8px;
            background: #0066cc;
            color: #fff;
            border: none;
            border-left: 1px solid #999;
            font-size: 11px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .send-button:active {
            background: #004499;
        }
        
        /* Индикатор статуса */
        .status-indicator {
            position: absolute;
            top: 3px;
            right: 60px;
            width: 8px;
            height: 8px;
            background: #00cc00;
            border-radius: 50%;
            border: 1px solid #fff;
        }
        
        .status-indicator.disconnected {
            background: #cc0000;
        }
        
        /* Загрузка и ошибки */
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        
        .error-message {
            background: #ffe6e6;
            color: #cc0000;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ffcccc;
            border-radius: 3px;
            text-align: center;
            font-size: 11px;
        }
        
        /* Адаптация для очень маленьких экранов */
        @media screen and (max-width: 240px) {
            body {
                font-size: 10px;
            }
            
            .login-box {
                padding: 15px;
                margin: 10px;
            }
            
            .login-title {
                font-size: 14px;
            }
            
            .text-input {
                padding: 6px 4px;
                font-size: 10px;
            }
            
            .message-bubble {
                max-width: 90%;
                padding: 4px 6px;
            }
            
            .message.user .message-bubble {
                margin-left: 10%;
            }
            
            .message.telegram .message-bubble {
                margin-right: 10%;
            }
            
            .message-text {
                font-size: 10px;
            }
            
            .input-area {
                padding: 4px;
            }
            
            .message-input,
            .send-button {
                font-size: 10px;
                padding: 5px 6px;
            }
        }
        
        /* Фиксы для очень старых браузеров */
        @media screen and (max-height: 320px) {
            .messages-area {
                min-height: 150px;
            }
            
            .login-wrapper {
                padding: 10px;
            }
        }
        
        /* Убираем flexbox для старых браузеров */
        .no-flexbox .chat-screen {
            display: block;
            height: 100vh;
            position: relative;
        }
        
        .no-flexbox .messages-area {
            position: absolute;
            top: 33px;
            bottom: 40px;
            left: 0;
            right: 0;
            overflow-y: auto;
        }
        
        .no-flexbox .input-area {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
        }
    </style>
</head>
<body>
    <!-- Экран входа -->
    <div id="loginScreen" class="screen login-screen">
        <div class="login-wrapper">
            <div class="login-box">
                <div class="login-title">Веб-чат</div>
                <div class="login-subtitle">Введите никнейм для входа</div>
                
                <div class="input-wrapper">
                    <label class="input-label">Никнейм:</label>
                    <input type="text" id="nicknameInput" class="text-input" maxlength="20" autocomplete="off">
                </div>
                
                <button class="login-button" onclick="login()">Войти в чат</button>
            </div>
        </div>
    </div>

    <!-- Экран чата -->
    <div id="chatScreen" class="screen chat-screen hidden">
        <div class="chat-header">
            <div class="user-info" id="userNick"></div>
            <div class="status-indicator" id="statusIndicator"></div>
            <button class="logout-button" onclick="logout()">Выход</button>
        </div>
        
        <div class="messages-area" id="messagesContainer">
            <div id="messagesList">
                <div class="loading">Загрузка чата...</div>
            </div>
        </div>
        
        <div class="input-area">
            <div class="input-container">
                <input type="text" id="messageInput" class="message-input" placeholder="Введите сообщение..." maxlength="500" autocomplete="off">
                <button class="send-button" onclick="sendMessage()">Отправить</button>
            </div>
        </div>
    </div>

    <script>
        var currentUser = null;
        var lastMessageTime = 0;
        var pollTimer = null;
        var connectionRetries = 0;
        var maxRetries = 3;
        
        // Проверка поддержки flexbox
        function checkFlexbox() {
            var elem = document.createElement('div');
            elem.style.display = 'flex';
            if (elem.style.display !== 'flex') {
                document.documentElement.className += ' no-flexbox';
            }
        }
        
        function createXHR() {
            if (window.XMLHttpRequest) return new XMLHttpRequest();
            if (window.ActiveXObject) {
                try { return new ActiveXObject('Microsoft.XMLHTTP'); }
                catch(e) { 
                    try { return new ActiveXObject('Msxml2.XMLHTTP'); } 
                    catch(e2) { return null; } 
                }
            }
            return null;
        }
        
        function trim(str) {
            return str.replace(/^\s+|\s+$/g, '');
        }
        
        function updateStatus(connected) {
            var indicator = document.getElementById('statusIndicator');
            if (indicator) {
                indicator.className = 'status-indicator' + (connected ? '' : ' disconnected');
            }
        }
        
        function login() {
            var input = document.getElementById('nicknameInput');
            var nickname = trim(input.value);
            
            if (nickname.length < 2) {
                alert('Никнейм должен содержать минимум 2 символа');
                input.focus();
                return;
            }
            
            currentUser = nickname;
            document.getElementById('userNick').innerHTML = nickname;
            
            document.getElementById('loginScreen').className = 'screen login-screen hidden';
            document.getElementById('chatScreen').className = 'screen chat-screen';
            
            setTimeout(function() {
                var msgInput = document.getElementById('messageInput');
                if (msgInput && msgInput.focus) msgInput.focus();
            }, 100);
            
            loadHistory();
        }
        
        function loadHistory() {
            updateStatus(false);
            
            var xhr = createXHR();
            if (!xhr) {
                showError('Браузер не поддерживается');
                return;
            }
            
            xhr.open('GET', '/api/messages?limit=15', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    removeLoading();
                    
                    if (xhr.status == 200) {
                        try {
                            var messages = eval('(' + xhr.responseText + ')');
                            displayMessages(messages);
                            updateStatus(true);
                            connectionRetries = 0;
                            startPolling();
                        } catch (e) {
                            showError('Ошибка загрузки данных');
                            retryConnection();
                        }
                    } else {
                        showError('Ошибка сервера: ' + xhr.status);
                        retryConnection();
                    }
                }
            };
            xhr.send();
        }
        
        function retryConnection() {
            connectionRetries++;
            if (connectionRetries < maxRetries) {
                setTimeout(function() {
                    showSystemMessage('Переподключение ' + connectionRetries + '/' + maxRetries);
                    loadHistory();
                }, 3000);
            } else {
                showError('Не удалось подключиться к серверу');
            }
        }
        
        function startPolling() {
            if (pollTimer) clearInterval(pollTimer);
            
            pollTimer = setInterval(function() {
                var xhr = createXHR();
                if (!xhr) return;
                
                xhr.open('GET', '/api/messages?since=' + lastMessageTime, true);
                xhr.onreadystatechange = function() {
                    if (xhr.readyState == 4) {
                        if (xhr.status == 200) {
                            try {
                                var messages = eval('(' + xhr.responseText + ')');
                                if (messages.length > 0) {
                                    for (var i = 0; i < messages.length; i++) {
                                        appendMessage(messages[i]);
                                        if (messages[i].timestamp > lastMessageTime) {
                                            lastMessageTime = messages[i].timestamp;
                                        }
                                    }
                                }
                                updateStatus(true);
                                connectionRetries = 0;
                            } catch (e) {}
                        } else {
                            updateStatus(false);
                        }
                    }
                };
                xhr.send();
            }, 1500);
        }
        
        function displayMessages(messages) {
            var html = '';
            for (var i = 0; i < messages.length; i++) {
                html += formatMessage(messages[i]);
                if (messages[i].timestamp > lastMessageTime) {
                    lastMessageTime = messages[i].timestamp;
                }
            }
            document.getElementById('messagesList').innerHTML = html;
            scrollToBottom();
        }
        
        function appendMessage(msg) {
            var list = document.getElementById('messagesList');
            list.innerHTML += formatMessage(msg);
            scrollToBottom();
        }
        
        function formatMessage(msg) {
            var time = new Date(msg.timestamp);
            var hours = time.getHours();
            var minutes = time.getMinutes();
            if (hours < 10) hours = '0' + hours;
            if (minutes < 10) minutes = '0' + minutes;
            
            var sourceClass = msg.source || 'user';
            var prefix = msg.source === 'telegram' ? 'Telegram' : 'Веб';
            
            return '<div class="message ' + sourceClass + '">' +
                   '<div class="message-bubble">' +
                   '<div class="message-header">' + prefix + ' • ' + escapeHtml(msg.nickname) + '</div>' +
                   '<div class="message-text">' + escapeHtml(msg.text) + '</div>' +
                   '<div class="message-time">' + hours + ':' + minutes + '</div>' +
                   '</div>' +
                   '</div>';
        }
        
        function escapeHtml(text) {
            var div = document.createElement('div');
            if (div.textContent !== undefined) {
                div.textContent = text;
            } else {
                div.innerText = text;
            }
            return div.innerHTML;
        }
        
        function sendMessage() {
            var input = document.getElementById('messageInput');
            var text = trim(input.value);
            
            if (!text) return;
            
            var timestamp = new Date().getTime();
            
            // Показать сообщение
            var msg = {
                nickname: currentUser,
                text: text,
                timestamp: timestamp,
                source: 'user'
            };
            appendMessage(msg);
            input.value = '';
            
            // Отправить на сервер
            var xhr = createXHR();
            if (!xhr) return;
            
            xhr.open('POST', '/api/messages', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    if (xhr.status == 200) {
                        updateStatus(true);
                        lastMessageTime = timestamp;
                    } else {
                        updateStatus(false);
                        showSystemMessage('Ошибка отправки');
                    }
                }
            };
            
            var data = '{"nickname":"' + currentUser.replace(/"/g, '\\"') + '","text":"' + text.replace(/"/g, '\\"') + '","timestamp":' + timestamp + '}';
            xhr.send(data);
        }
        
        function scrollToBottom() {
            var container = document.getElementById('messagesContainer');
            if (container) {
                setTimeout(function() {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }
        }
        
        function logout() {
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
            
            currentUser = null;
            lastMessageTime = 0;
            connectionRetries = 0;
            
            document.getElementById('messagesList').innerHTML = '<div class="loading">Загрузка чата...</div>';
            document.getElementById('nicknameInput').value = '';
            
            document.getElementById('chatScreen').className = 'screen chat-screen hidden';
            document.getElementById('loginScreen').className = 'screen login-screen';
            
            updateStatus(false);
            
            setTimeout(function() {
                var nickInput = document.getElementById('nicknameInput');
                if (nickInput && nickInput.focus) nickInput.focus();
            }, 100);
        }
        
        function removeLoading() {
            var loading = document.querySelector('.loading');
            if (loading && loading.parentNode) {
                loading.parentNode.removeChild(loading);
            }
        }
        
        function showError(text) {
            var list = document.getElementById('messagesList');
            list.innerHTML = '<div class="error-message">' + text + '</div>';
        }
        
        function showSystemMessage(text) {
            var msg = {
                nickname: 'Система',
                text: text,
                timestamp: new Date().getTime(),
                source: 'error'
            };
            appendMessage(msg);
        }
        
        function handleKeyPress(event, action) {
            var keyCode = event.keyCode || event.which;
            if (keyCode == 13) {
                if (action == 'login') login();
                else if (action == 'send') sendMessage();
                return false;
            }
            return true;
        }
        
        window.onload = function() {
            checkFlexbox();
            
            var nickInput = document.getElementById('nicknameInput');
            var msgInput = document.getElementById('messageInput');
            
            if (nickInput && nickInput.addEventListener) {
                nickInput.addEventListener('keypress', function(e) { return handleKeyPress(e, 'login'); }, false);
                msgInput.addEventListener('keypress', function(e) { return handleKeyPress(e, 'send'); }, false);
            } else if (nickInput) {
                nickInput.onkeypress = function(e) { return handleKeyPress(e || window.event, 'login'); };
                msgInput.onkeypress = function(e) { return handleKeyPress(e || window.event, 'send'); };
            }
            
            setTimeout(function() {
                if (nickInput && nickInput.focus) nickInput.focus();
            }, 200);
        };
    </script>
</body>
</html>
            };
            appendMessage(msg);
            input.value = '';
            
            // Отправить на сервер
            var xhr = createXHR();
            if (!xhr) {
                showError('Невозможно отправить сообщение');
                return;
            }
            
            xhr.open('POST', '/api/messages', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.timeout = 10000;
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4) {
                    if (xhr.status == 200) {
                        updateConnectionStatus(true);
                        lastMessageTime = timestamp;
                        connectionRetries = 0;
                    } else {
                        updateConnectionStatus(false);
                        showError('Ошибка отправки: ' + xhr.status);
                    }
                }
            };
            
            xhr.onerror = function() {
                updateConnectionStatus(false);
                showError('Ошибка сети при отправке');
            };
            
            xhr.ontimeout = function() {
                updateConnectionStatus(false);
                showError('Таймаут при отправке');
            };
            
            var data;
            if (window.JSON && JSON.stringify) {
                data = JSON.stringify({
                    nickname: currentUser,
                    text: text,
                    timestamp: timestamp
                });
            } else {
                // Fallback для старых браузеров
                data = '{"nickname":"' + currentUser.replace(/"/g, '\\"') + '","text":"' + text.replace(/"/g, '\\"') + '","timestamp":' + timestamp + '}';
            }
            
            xhr.send(data);
        }
        
        function scrollToBottom() {
            var container = document.getElementById('messagesContainer');
            if (container) {
                setTimeout(function() {
                    container.scrollTop = container.scrollHeight;
                }, 50);
            }
        }
        
        function logout() {
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
            
            currentUser = null;
            lastMessageTime = 0;
            connectionRetries = 0;
            
            document.getElementById('messagesList').innerHTML = '<div class="loading">Загрузка истории чата...</div>';
            document.getElementById('nicknameInput').value = '';
            
            document.getElementById('chatScreen').className = 'screen chat-screen hidden';
            document.getElementById('loginScreen').className = 'screen login-screen';
            
            updateConnectionStatus(false);
            
            // Фокус на поле ввода никнейма
            setTimeout(function() {
                var nickInput = document.getElementById('nicknameInput');
                if (nickInput && nickInput.focus) {
                    nickInput.focus();
                }
            }, 100);
        }
        
        function removeLoading() {
            var loading = document.querySelector('.loading');
            if (loading && loading.parentNode) {
                loading.parentNode.removeChild(loading);
            }
        }
        
        function showError(text) {
            showMessage('Система', text, 'error');
        }
        
        // Обработка Enter
        function handleKeyPress(event, action) {
            var keyCode = event.keyCode || event.which;
            if (keyCode == 13) {
                if (action == 'login') {
                    login();
                } else if (action == 'send') {
                    sendMessage();
                }
                return false;
            }
            return true;
        }
        
        // Инициализация
        window.onload = function() {
            var nickInput = document.getElementById('nicknameInput');
            var msgInput = document.getElementById('messageInput');
            
            // Обработчики Enter
            if (nickInput && nickInput.addEventListener) {
                nickInput.addEventListener('keypress', function(e) { return handleKeyPress(e, 'login'); }, false);
                msgInput.addEventListener('keypress', function(e) { return handleKeyPress(e, 'send'); }, false);
            } else if (nickInput) {
                // Fallback для старых браузеров
                nickInput.onkeypress = function(e) { return handleKeyPress(e || window.event, 'login'); };
                msgInput.onkeypress = function(e) { return handleKeyPress(e || window.event, 'send'); };
            }
            
            // Автофокус
            setTimeout(function() {
                if (nickInput && nickInput.focus) {
                    nickInput.focus();
                }
            }, 100);
        };
    </script>
</body>
</html>
